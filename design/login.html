<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify PKCE Demo</title>
    <link rel="icon" href="https://fav.farm/üéµ">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <style>
        input:invalid {
            border: 2px solid red;
        }

        output {
            background-color: lightgray;
            font-family: 'Courier New', Courier, monospace;
            word-break: break-all;
        }

        label {
            font-weight: bold;
        }

        li {
            margin-block-end: 1rem;
        }
    </style>
</head>
<body>
<h1>Spotify PKCE Demo</h1>
<p>"Client-side-only" Spotify api consumption. find source code here <a href="https://github.com/hcientist/Spotify-PKCE-Example">https://github.com/hcientist/Spotify-PKCE-Example</a></p>
<button type="button" id="authorize">Authorize</button>

<details id="get-token" style="display:none;">
    <summary>
        <h2>Getting (access)Token</h2>
    </summary>
    <ol>
        <li><button type="button" id="token">Get Token</button></li>
    </ol>
</details>

<label for="token-output">(access) token:</label> <output id="token-output" name="token-output"></output>

<h2>Have token, make api request(s)</h2>
<ul>
    <li><button type="button" id="profile">Get my profile</button></li>
    <li>Search for items on Spotify<br><label for="query">Search query:</label><input size="32" type="text" name="query"
                                                                                     id="query"><button type="button"
                                                                                                         id="search-button">Search</button>
    </li>
    <li>Play items in the active spotify player for this user's account (something should be playing or recently played
        in spotify for this account. on the computer, mobile or really anywhere should work fine.)
        <label for="uris">space-separated list of spotify uris</label>
        <textarea name="uris" id="uris" cols="36"
                  placeholder="spotify:track:39rHfrVqCX6A55GF7uOZSC spotify:track:0grFc6klR3hxoHLcgCYsF4"></textarea>
        <button type="button" id="play-button">‚ñ∂Ô∏è</button>
    </li>
</ul>
<output id="api-output"></output>

<script>
    document.getElementById('authorize').addEventListener('click', () => {
        // Get client ID and redirect URI
        const clientId = 'bca2a89f33694250b5b79633e3435a39';
        const redirectUri = 'https://mart32jm.github.io/design/login.html';
        // Generate a code verifier
        const codeVerifier = generateRandomString(128);
        // Generate code challenge
        generateCodeChallenge(codeVerifier)
            .then(codeChallenge => {
                localStorage.setItem('code_verifier', codeVerifier);
                const state = generateRandomString(16);
                const scope = 'user-read-private user-read-email user-modify-playback-state';
                const args = new URLSearchParams({
                    response_type: 'code',
                    client_id: clientId,
                    scope: scope,
                    redirect_uri: redirectUri,
                    state: state,
                    code_challenge_method: 'S256',
                    code_challenge: codeChallenge
                });
                window.location = 'https://accounts.spotify.com/authorize?' + args;
            });
    });

    document.getElementById('token').addEventListener('click', () => {
        const code = new URLSearchParams(window.location.search).get('code');
        if (!code) {
            console.error('No authorization code found.');
            return;
        }
        getToken('bca2a89f33694250b5b79633e3435a39', 'https://mart32jm.github.io/design/login.html', code)
            .then(token => {
                document.getElementById('token-output').value = token;
                getProfile(token);
            });
    });

    document.getElementById('profile').addEventListener('click', () => {
        const token = localStorage.getItem('access_token');
        if (!token) {
            console.error('No access token found.');
            return;
        }
        getProfile(token);
    });

    // Other functions and event listeners remain the same as in your original code

    function generateRandomString(length) {
        let text = '';
        const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        for (let i = 0; i < length; i++) {
            text += possible.charAt(Math.floor(Math.random() * possible.length));
        }
        return text;
    }

    function generateCodeChallenge(codeVerifier) {
        function base64encode(string) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(string)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        const encoder = new TextEncoder();
        const data = encoder.encode(codeVerifier);
        const digest = window.crypto.subtle.digest('SHA-256', data);

        return digest.then(d => base64encode(d));
    }

    function getToken(clientId, redirectUri, code) {
        const codeVerifier = localStorage.getItem('code_verifier');
        const body = new URLSearchParams({
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: redirectUri,
            client_id: clientId,
            code_verifier: codeVerifier
        });

        return fetch('https://accounts.spotify.com/api/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: body
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP status ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                localStorage.setItem('access_token', data.access_token);
                document.getElementById('get-token').style.display = 'none';
                return data.access_token;
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function getProfile(accessToken) {
        fetch('https://api.spotify.com/v1/me', {
            headers: {
                Authorization: 'Bearer ' + accessToken
            }
        }).then(response => {
            if (!response.ok) {
                throw new Error('HTTP status ' + response.status);
            }
            return response.json();
        }).then(profile => {
            console.log(profile);
            document.getElementById('api-output').value = JSON.stringify(profile, null, 2);
        }).catch(error => {
            console.error('Error:', error);
        });
    }

    // Other functions remain the same as in your original code

</script>
</body>
</html>
